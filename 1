import os
import time
import asyncio
from datetime import datetime, timedelta
from telegram import Bot
from telegram.error import TelegramError

# Telegram Bot è®¾ç½®
TELEGRAM_TOKEN = '7698800335:AAEeiykr_tJgyZBUxrb6VhXbpH17FmbyAl4'  # æ›¿æ¢ä¸ºæ­£ç¡®çš„Bot Token
CHANNEL_ID = '-1002586693525'  # æ›¿æ¢ä¸ºæ­£ç¡®çš„é¢‘é“ID
image_folder = './generated_files'  # å­˜å‚¨å›¾ç‰‡çš„æ–‡ä»¶å¤¹

print("ç¨‹åºåˆå§‹åŒ–ä¸­...")
print(f"ä½¿ç”¨çš„Bot Token: {TELEGRAM_TOKEN}")
print(f"ç›®æ ‡é¢‘é“ID: {CHANNEL_ID}")
print(f"å›¾ç‰‡æ–‡ä»¶å¤¹è·¯å¾„: {image_folder}")

# ç”Ÿæˆå‘é€æ¶ˆæ¯çš„æ–‡æœ¬
def generate_text(amount):
    bonus = float(amount.split()[0]) * 0.30 + float(amount.split()[0])
    print(f"ç”Ÿæˆæ¶ˆæ¯æ–‡æœ¬ï¼Œé‡‘é¢: {amount}ï¼Œè®¡ç®—åé‡‘é¢: {bonus:.3f}")
    return f"Basta dar os parabÃ©ns ao utilizador por completar uma encomenda no valor de {amount} e retirar {bonus:.3f}ğŸ¥³"

# å¼‚æ­¥å‘é€æ¶ˆæ¯å’Œå›¾ç‰‡
async def send_message_and_image(bot, chat_id, amount, image_path):
    print(f"å‡†å¤‡å‘é€æ¶ˆæ¯å’Œå›¾ç‰‡ï¼Œé‡‘é¢: {amount}ï¼Œå›¾ç‰‡è·¯å¾„: {image_path}")
    text = generate_text(amount)
    
    try:
        print(f"æ­£åœ¨å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼š{text}")
        message = await bot.send_message(chat_id=chat_id, text=text)
        print(f"æ–‡æœ¬æ¶ˆæ¯å‘é€æˆåŠŸï¼Œæ¶ˆæ¯ID: {message.message_id}")
        
        print(f"æ­£åœ¨å‘é€å›¾ç‰‡ï¼š{image_path}")
        with open(image_path, 'rb') as photo:
            photo_message = await bot.send_photo(chat_id=chat_id, photo=photo)
        print(f"å›¾ç‰‡å‘é€æˆåŠŸï¼Œæ¶ˆæ¯ID: {photo_message.message_id}")
        print(f"æˆåŠŸå‘é€ï¼š{image_path} | é‡‘é¢ï¼š{amount}")
    except TelegramError as e:
        print(f"å‘é€æ¶ˆæ¯å¤±è´¥ï¼š{e}")
        print(f"é”™è¯¯ç±»å‹: {type(e).__name__}")
        return False
    except FileNotFoundError:
        print(f"æ–‡ä»¶æœªæ‰¾åˆ°ï¼š{image_path}")
        print(f"å½“å‰å·¥ä½œç›®å½•: {os.getcwd()}")
        print(f"æ–‡ä»¶å¤¹å†…å®¹: {os.listdir(os.path.dirname(image_path))}")
        return False
    except Exception as e:
        print(f"å‘é€è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š{e}")
        print(f"é”™è¯¯ç±»å‹: {type(e).__name__}")
        print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")
        return False
    return True

# è·å–å‘½åè§„åˆ™çš„å›¾ç‰‡æ–‡ä»¶å’Œé‡‘é¢
def get_image_and_amount(file_name):
    print(f"æ­£åœ¨è§£ææ–‡ä»¶å: {file_name}")
    try:
        time_part, amount_part = file_name.split('_')[:3], file_name.split('_')[3]
        time_str = f"{time_part[0]}:{time_part[1]}:{time_part[2]}"
        amount = amount_part.split()[0]
        print(f"æˆåŠŸè§£ææ–‡ä»¶åï¼Œæ—¶é—´: {time_str}ï¼Œé‡‘é¢: {amount}")
        return time_str, amount
    except Exception as e:
        print(f"è§£ææ–‡ä»¶åå‡ºé”™ï¼š{file_name} é”™è¯¯ï¼š{e}")
        print(f"é”™è¯¯ç±»å‹: {type(e).__name__}")
        print(f"æ–‡ä»¶åæ ¼å¼åº”ä¸º: HH_MM_SS_é‡‘é¢ å…¶ä»–ä¿¡æ¯.jpg")
        return None, None

# å®šæ—¶å‘é€æ¶ˆæ¯å’Œå›¾ç‰‡
async def send_scheduled_messages():
    print("å¼€å§‹åˆå§‹åŒ–Botå®ä¾‹...")
    bot = Bot(token=TELEGRAM_TOKEN)
    print("Botå®ä¾‹åˆ›å»ºæˆåŠŸ")
    
    print(f"æ­£åœ¨æ£€æŸ¥å›¾ç‰‡æ–‡ä»¶å¤¹: {image_folder}")
    if not os.path.exists(image_folder):
        print(f"è­¦å‘Š: å›¾ç‰‡æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–‡ä»¶å¤¹")
        os.makedirs(image_folder)
    
    # è®°å½•å·²å¤„ç†çš„æ–‡ä»¶
    processed_files = set()
    
    print("å¼€å§‹è¿›å…¥å®šæ—¶å‘é€å¾ªç¯...")
    while True:
        current_time = datetime.now()
        current_hour = current_time.hour
        current_minute = current_time.minute
        print(f"å½“å‰æ—¶é—´: {current_time.strftime('%Y-%m-%d %H:%M:%S')}")

        # åªåœ¨10:00åˆ°20:00ä¹‹é—´å‘é€
        if 10 <= current_hour < 20:
            print(f"å½“å‰æ—¶é—´ï¼š{current_time.strftime('%H:%M:%S')}ï¼Œåœ¨å‘é€æ—¶é—´èŒƒå›´å†…ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦å‘é€çš„å›¾ç‰‡ã€‚")
            
            # é‡æ–°è·å–æ–‡ä»¶åˆ—è¡¨ï¼Œä»¥é˜²æœ‰æ–°æ–‡ä»¶æ·»åŠ 
            image_files = sorted([f for f in os.listdir(image_folder) if (f.endswith('.jpg') or f.endswith('.png')) and f not in processed_files])
            print(f"æœªå¤„ç†çš„å›¾ç‰‡æ–‡ä»¶æ€»æ•°ï¼š{len(image_files)}")
            
            if len(image_files) == 0:
                print("æ²¡æœ‰æ–°çš„å›¾ç‰‡æ–‡ä»¶éœ€è¦å¤„ç†")
            else:
                print(f"æ‰¾åˆ°çš„æœªå¤„ç†å›¾ç‰‡æ–‡ä»¶: {', '.join(image_files[:5])}{'...' if len(image_files) > 5 else ''}")
                
                # æ‰¾åˆ°å½“å‰æ—¶é—´åº”è¯¥å‘é€çš„å›¾ç‰‡
                image_to_send = None
                for image_file in image_files:
                    file_time_str, amount = get_image_and_amount(image_file)
                    
                    if not file_time_str or not amount:
                        print(f"è·³è¿‡æ–‡ä»¶ï¼š{image_file}ï¼Œå› ä¸ºè§£æå¤±è´¥ã€‚")
                        processed_files.add(image_file)  # æ ‡è®°ä¸ºå·²å¤„ç†ï¼Œé¿å…é‡å¤å°è¯•è§£æ
                        continue
                    
                    file_time = datetime.strptime(file_time_str, "%H:%M:%S").replace(
                        year=current_time.year, 
                        month=current_time.month, 
                        day=current_time.day
                    )
                    print(f"æ–‡ä»¶æ—¶é—´: {file_time.strftime('%Y-%m-%d %H:%M:%S')}")
                    
                    # å¦‚æœæ–‡ä»¶æ—¶é—´å·²åˆ°æˆ–å·²è¿‡ï¼Œä¸”åœ¨å½“å‰æ—¶é—´çš„å‰å5åˆ†é’Ÿå†…ï¼Œåˆ™å‘é€
                    time_diff = abs((current_time - file_time).total_seconds()) / 60
                    if time_diff <= 5:
                        image_to_send = image_file
                        image_amount = amount
                        break
                
                # å¦‚æœæ‰¾åˆ°äº†ç¬¦åˆæ¡ä»¶çš„å›¾ç‰‡ï¼Œå‘é€å®ƒ
                if image_to_send:
                    image_path = os.path.join(image_folder, image_to_send)
                    print(f"å‡†å¤‡å‘é€å›¾ç‰‡ï¼š{image_to_send}ï¼Œé‡‘é¢ï¼š{image_amount} Kzï¼Œå®Œæ•´è·¯å¾„: {image_path}")
                    success = await send_message_and_image(bot, CHANNEL_ID, f"{image_amount} Kz", image_path)
                    
                    if success:
                        print(f"æˆåŠŸå‘é€å›¾ç‰‡ï¼š{image_to_send}ï¼Œé‡‘é¢ï¼š{image_amount} Kz")
                        processed_files.add(image_to_send)  # æ ‡è®°ä¸ºå·²å¤„ç†
                    else:
                        print(f"å‘é€å›¾ç‰‡å¤±è´¥ï¼š{image_to_send}ï¼Œå°†åœ¨ä¸‹æ¬¡å°è¯•")
                else:
                    print("æ²¡æœ‰æ‰¾åˆ°å½“å‰æ—¶é—´éœ€è¦å‘é€çš„å›¾ç‰‡")
        else:
            print(f"å½“å‰æ—¶é—´ä¸åœ¨å‘é€èŒƒå›´å†…ï¼Œè·³è¿‡å‘é€ã€‚(å°æ—¶: {current_hour})")
        
        next_check = current_time + timedelta(minutes=1)
        print(f"ä¸‹æ¬¡æ£€æŸ¥æ—¶é—´: {next_check.strftime('%H:%M:%S')}")
        await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

if __name__ == "__main__":
    try:
        print("=== ç¨‹åºå¯åŠ¨ ===")
        print(f"å½“å‰æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
        print("å¼€å§‹å‘é€å®šæ—¶æ¶ˆæ¯...")
        asyncio.run(send_scheduled_messages())
    except KeyboardInterrupt:
        print("\nç¨‹åºè¢«ç”¨æˆ·ä¸­æ–­")
    except Exception as e:
        print(f"å‡ºç°é”™è¯¯ï¼š{e}")
        print(f"é”™è¯¯ç±»å‹: {type(e).__name__}")
        print(f"é”™è¯¯è¯¦æƒ…: {str(e)}")
        print("ç¨‹åºå¼‚å¸¸ç»ˆæ­¢")
