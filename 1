import os
import time
import asyncio
from datetime import datetime, timedelta
from telegram import Bot
from telegram.error import TelegramError

# Telegram Bot è®¾ç½®
TELEGRAM_TOKEN = 'ä½ çš„Bot Token'  # æ›¿æ¢æˆä½ çš„ Bot Token
CHANNEL_ID = 'ä½ çš„é¢‘é“ ID'  # æ›¿æ¢æˆä½ çš„é¢‘é“ ID
image_folder = './generated_files'  # å­˜å‚¨å›¾ç‰‡çš„æ–‡ä»¶å¤¹

# ç”Ÿæˆå‘é€æ¶ˆæ¯çš„æ–‡æœ¬
def generate_text(amount):
    return f"Basta dar os parabÃ©ns ao utilizador por completar uma encomenda no valor de {amount} e retirar {(float(amount.split()[0]) * 0.30 + float(amount.split()[0])):.3f}ğŸ¥³"

# å¼‚æ­¥å‘é€æ¶ˆæ¯å’Œå›¾ç‰‡
async def send_message_and_image(bot, chat_id, amount, image_path):
    text = generate_text(amount)
    
    try:
        print(f"æ­£åœ¨å‘é€æ–‡æœ¬æ¶ˆæ¯ï¼š{text}")
        await bot.send_message(chat_id=chat_id, text=text)
        
        print(f"æ­£åœ¨å‘é€å›¾ç‰‡ï¼š{image_path}")
        with open(image_path, 'rb') as photo:
            await bot.send_photo(chat_id=chat_id, photo=photo)
        print(f"æˆåŠŸå‘é€ï¼š{image_path} | é‡‘é¢ï¼š{amount}")
    except TelegramError as e:
        print(f"å‘é€æ¶ˆæ¯å¤±è´¥ï¼š{e}")
        return False
    except Exception as e:
        print(f"å‘é€è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼š{e}")
        return False
    return True

# è·å–å‘½åè§„åˆ™çš„å›¾ç‰‡æ–‡ä»¶å’Œé‡‘é¢
def get_image_and_amount(file_name):
    try:
        time_part, amount_part = file_name.split('_')[:3], file_name.split('_')[3]
        time_str = f"{time_part[0]}:{time_part[1]}:{time_part[2]}"
        amount = amount_part.split()[0]
        return time_str, amount
    except Exception as e:
        print(f"è§£ææ–‡ä»¶åå‡ºé”™ï¼š{file_name} é”™è¯¯ï¼š{e}")
        return None, None

# å®šæ—¶å‘é€æ¶ˆæ¯å’Œå›¾ç‰‡
async def send_scheduled_messages():
    bot = Bot(token=TELEGRAM_TOKEN)
    image_files = sorted([f for f in os.listdir(image_folder) if f.endswith('.jpg') or f.endswith('.png')])

    print(f"å›¾ç‰‡æ–‡ä»¶æ€»æ•°ï¼š{len(image_files)}")
    
    while True:
        current_time = datetime.now()
        current_hour = current_time.hour
        current_minute = current_time.minute

        # åªåœ¨10:00åˆ°20:00ä¹‹é—´å‘é€
        if 10 <= current_hour < 20 and current_minute % 5 == 0:
            for image_file in image_files:
                file_time_str, amount = get_image_and_amount(image_file)

                if not file_time_str or not amount:
                    continue

                file_time = datetime.strptime(file_time_str, "%H:%M:%S").replace(year=current_time.year, month=current_time.month, day=current_time.day)

                if current_time >= file_time:
                    image_path = os.path.join(image_folder, image_file)
                    await send_message_and_image(bot, CHANNEL_ID, f"{amount} Kz", image_path)
                    break  # å‘é€å®Œä¸€å¼ å›¾ç‰‡åé€€å‡ºå¾ªç¯

        await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡

if __name__ == "__main__":
    try:
        asyncio.run(send_scheduled_messages())
    except Exception as e:
        print(f"å‡ºç°é”™è¯¯ï¼š{e}")
